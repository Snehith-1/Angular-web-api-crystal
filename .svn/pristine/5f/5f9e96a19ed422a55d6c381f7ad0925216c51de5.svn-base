using ems.crm.Models;
using ems.system.Models;
using ems.utilities.Functions;
using Newtonsoft.Json;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using RestSharp;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.Odbc;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.NetworkInformation;
using System.Web;
using System.Web.Http.Results;
using static ems.crm.Models.leadbank_list;
using static OfficeOpenXml.ExcelErrorValue;

namespace ems.crm.DataAccess
{
    public class DaShopifyCustomer
    {
        dbconn objdbconn = new dbconn();
        cmnfunctions objcmnfunctions = new cmnfunctions();
        HttpPostedFile httpPostedFile;

        string msSQL = string.Empty;
        OdbcDataReader objODBCDatareader;
        DataTable dt_datatable;
        string lssource_gid;
        string  lssource_name, lsleadbank_name, lscategoryindustry_name, lscountry_name, lsleadbank_gid, lscountry_gid,
            lsregion_name, lsbankcontact, msGetGid, msGetGid1, msGetGid2, msGetGid3, msGetGid4,
            msGetGid5, msGetGid6, msGetGid7, msGetGid8, msGetGid9, msGetGid10, msGetGid11;
        int mnResult, mnResult1, mnResult2, mnResult3, mnResult4, mnResult5,
            mnResult6, mnResult7, mnResult8, mnResult9, mnResult10, mnResult11,
            mnResult12, mnResult13, mnResult14, mnResult15, mnResult16, mnResult17, mnResult18, mnResult19;
        char lsstatus, lsaddtocustomer;
        ///code  by snehith
        public shopifycustomerlist DaGetShopifyCustomer()
        {


            ServicePointManager.SecurityProtocol = SecurityProtocolType.Ssl3 | SecurityProtocolType.Tls12 | SecurityProtocolType.Tls11 | SecurityProtocolType.Tls;

            //var client = new RestClient("https://e32524.myshopify.com");

            var client = new RestClient("https://" + ConfigurationManager.AppSettings["shopify_store"] + ".myshopify.com");
            var request = new RestRequest("/admin/api/" + ConfigurationManager.AppSettings["store_month"] + "/customers.json?limit=250", Method.GET);
            request.AddHeader("X-Shopify-Access-Token", "" + ConfigurationManager.AppSettings["access_token"] + "");
            request.AddHeader("Cookie", "_master_udr=eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaEpJaWxqWXpsak9UQXhPUzAyWkRZMkxUUXlOR1F0T0RKbVl5MDNaVEZsTnpFM09EY3dOV0lHT2daRlJnPT0iLCJleHAiOiIyMDI1LTEwLTIwVDA4OjI3OjU2LjU4MloiLCJwdXIiOiJjb29raWUuX21hc3Rlcl91ZHIifX0%3D--6f6310c22570c2812426da811c5f9f64d2d35161; _secure_admin_session_id=bbc22793fbba552b04eeebfaeb0de080; _secure_admin_session_id_csrf=bbc22793fbba552b04eeebfaeb0de080; identity-state=BAhbB0kiJWVhODM3YTZhN2M3Njg1MzhlNWQ3MTNhYzg2NmM5MWUwBjoGRUZJIiUwY2M0MWQ1ZjE4ZTQwZTcwYWQ1ZTVkMWUzMDBkMzZlYgY7AEY%3D--69633ab3c25bb20e105bbe14b912f36422abe9b1; identity-state-0cc41d5f18e40e70ad5e5d1e300d36eb=BAh7DEkiDnJldHVybi10bwY6BkVUSSI0aHR0cHM6Ly9lNDQ1NWYtMi5teXNob3BpZnkuY29tL2FkbWluL2F1dGgvbG9naW4GOwBUSSIRcmVkaXJlY3QtdXJpBjsAVEkiQGh0dHBzOi8vZTQ0NTVmLTIubXlzaG9waWZ5LmNvbS9hZG1pbi9hdXRoL2lkZW50aXR5L2NhbGxiYWNrBjsAVEkiEHNlc3Npb24ta2V5BjsAVDoMYWNjb3VudEkiD2NyZWF0ZWQtYXQGOwBUZhcxNjk3NzkxOTE0LjQyODUwMDJJIgpub25jZQY7AFRJIiU1YTQyNzRiZTI5ZmVjODE0MDU4ZTlmNGU3ZGZiNzU4MwY7AEZJIgpzY29wZQY7AFRbEEkiCmVtYWlsBjsAVEkiN2h0dHBzOi8vYXBpLnNob3BpZnkuY29tL2F1dGgvZGVzdGluYXRpb25zLnJlYWRvbmx5BjsAVEkiC29wZW5pZAY7AFRJIgxwcm9maWxlBjsAVEkiTmh0dHBzOi8vYXBpLnNob3BpZnkuY29tL2F1dGgvcGFydG5lcnMuY29sbGFib3JhdG9yLXJlbGF0aW9uc2hpcHMucmVhZG9ubHkGOwBUSSIwaHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9iYW5raW5nLm1hbmFnZQY7AFRJIkJodHRwczovL2FwaS5zaG9waWZ5LmNvbS9hdXRoL21lcmNoYW50LXNldHVwLWRhc2hib2FyZC5ncmFwaHFsBjsAVEkiPGh0dHBzOi8vYXBpLnNob3BpZnkuY29tL2F1dGgvc2hvcGlmeS1jaGF0LmFkbWluLmdyYXBocWwGOwBUSSI3aHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9mbG93LndvcmtmbG93cy5tYW5hZ2UGOwBUSSI%2BaHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9vcmdhbml6YXRpb24taWRlbnRpdHkubWFuYWdlBjsAVEkiPmh0dHBzOi8vYXBpLnNob3BpZnkuY29tL2F1dGgvbWVyY2hhbnQtYmFuay1hY2NvdW50Lm1hbmFnZQY7AFRJIg9jb25maWcta2V5BjsAVEkiDGRlZmF1bHQGOwBU--eb8709d3d8002d429911a5b1c28afca37dd02431; identity-state-ea837a6a7c768538e5d713ac866c91e0=BAh7DEkiDnJldHVybi10bwY6BkVUSSI0aHR0cHM6Ly9lNDQ1NWYtMi5teXNob3BpZnkuY29tL2FkbWluL2F1dGgvbG9naW4GOwBUSSIRcmVkaXJlY3QtdXJpBjsAVEkiQGh0dHBzOi8vZTQ0NTVmLTIubXlzaG9waWZ5LmNvbS9hZG1pbi9hdXRoL2lkZW50aXR5L2NhbGxiYWNrBjsAVEkiEHNlc3Npb24ta2V5BjsAVDoMYWNjb3VudEkiD2NyZWF0ZWQtYXQGOwBUZhYxNjk3NzkwNDc2LjU5MTkxOEkiCm5vbmNlBjsAVEkiJWM5NjYwYTQ2NmZhMTlhZTJlNDQyYmM3NjU0NDMxZWMzBjsARkkiCnNjb3BlBjsAVFsQSSIKZW1haWwGOwBUSSI3aHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9kZXN0aW5hdGlvbnMucmVhZG9ubHkGOwBUSSILb3BlbmlkBjsAVEkiDHByb2ZpbGUGOwBUSSJOaHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9wYXJ0bmVycy5jb2xsYWJvcmF0b3ItcmVsYXRpb25zaGlwcy5yZWFkb25seQY7AFRJIjBodHRwczovL2FwaS5zaG9waWZ5LmNvbS9hdXRoL2JhbmtpbmcubWFuYWdlBjsAVEkiQmh0dHBzOi8vYXBpLnNob3BpZnkuY29tL2F1dGgvbWVyY2hhbnQtc2V0dXAtZGFzaGJvYXJkLmdyYXBocWwGOwBUSSI8aHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9zaG9waWZ5LWNoYXQuYWRtaW4uZ3JhcGhxbAY7AFRJIjdodHRwczovL2FwaS5zaG9waWZ5LmNvbS9hdXRoL2Zsb3cud29ya2Zsb3dzLm1hbmFnZQY7AFRJIj5odHRwczovL2FwaS5zaG9waWZ5LmNvbS9hdXRoL29yZ2FuaXphdGlvbi1pZGVudGl0eS5tYW5hZ2UGOwBUSSI%2BaHR0cHM6Ly9hcGkuc2hvcGlmeS5jb20vYXV0aC9tZXJjaGFudC1iYW5rLWFjY291bnQubWFuYWdlBjsAVEkiD2NvbmZpZy1rZXkGOwBUSSIMZGVmYXVsdAY7AFQ%3D--7f37bdb0df101ca716441e71427765ef41612063");
            IRestResponse responseAddress = client.Execute(request);
            string address_erpid = responseAddress.Content;
            string errornetsuiteJSON = responseAddress.Content;
            shopifycustomerlist objMdlShopifyMessageResponse = new shopifycustomerlist();
            objMdlShopifyMessageResponse = JsonConvert.DeserializeObject<shopifycustomerlist>(errornetsuiteJSON);
            if (responseAddress.StatusCode == HttpStatusCode.OK)
            {
                msSQL = "  delete from crm_trn_tshopifycustomer  ";
                mnResult = objdbconn.ExecuteNonQuerySQL(msSQL);
                foreach (var item in objMdlShopifyMessageResponse.customers)
                {


                    msSQL = " insert into crm_trn_tshopifycustomer(" +
                   " shopify_id," +
                   " first_name," +
                   " last_name," +
                   " email," +
                   " orders_count," +
                   " total_spent," +
                   " email_state," +
                   " default_company," +
                   " default_address1," +
                   " default_address2," +
                   " default_city," +
                   " default_country," +
                   " default_countrycode," +
                   " default_zip," +
                   " default_phone," +
                   " last_order_id)" +
                   " values(" +
                   "'" + item.id + "'," +
                   "'" + item.first_name + "'," +
                   "'" + item.last_name + "'," +
                   "'" + item.email + "'," +
                   "'" + item.orders_count + "'," +
                   "'" + item.total_spent + "'," +
                   "'" + item.email_marketing_consent.state + "',";
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.company + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.address1 + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.address2 + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.city + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.country + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.country_code + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.zip + "',";
                    }
                    if (item.default_address == null)
                    {
                        msSQL += "'" + null + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + item.default_address.phone + "',";
                    }
                    msSQL += "'" + item.last_order_id + "')";

                    mnResult = objdbconn.ExecuteNonQuerySQL(msSQL);
                }
            }
                

            return objMdlShopifyMessageResponse;


        }
        public void DaGetShopifyCustomersList(MdlShopifyCustomer values)
        { 
            msSQL = " select a.shopify_id,first_name,id, last_name, email, orders_count, last_order_id, total_spent, email_state, default_company, default_address1, default_address2, " +
                    "default_city, default_country, default_countrycode, default_zip, default_phone ,(case when a.shopify_id=b.shopify_id then 'Assigned' when b.shopify_id is null then 'Not Assign' end) as status_flag " +
                    " from crm_trn_tshopifycustomer a " +
                    " left join crm_trn_tleadbank b on a.shopify_id=b.shopify_id group by a.shopify_id";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var getModuleList = new List<shopifycustomers_list>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    getModuleList.Add(new shopifycustomers_list
                    {
                        shopify_id = dt["shopify_id"].ToString(),
                        first_name = dt["first_name"].ToString(),
                        id = dt["id"].ToString(),
                        last_name = dt["last_name"].ToString(),
                        email = dt["email"].ToString(),
                        orders_count = dt["orders_count"].ToString(),
                        last_order_id = dt["last_order_id"].ToString(),
                        total_spent = dt["total_spent"].ToString(),
                        email_state = dt["email_state"].ToString(),
                        default_company = dt["default_company"].ToString(),
                        default_address1 = dt["default_address1"].ToString(),
                        default_address2 = dt["default_address2"].ToString(),
                        default_city = dt["default_city"].ToString(),
                        default_country = dt["default_country"].ToString(),
                        default_countrycode = dt["default_countrycode"].ToString(),
                        default_zip = dt["default_zip"].ToString(),
                        default_phone = dt["default_phone"].ToString(),
                        status_flag = dt["status_flag"].ToString(),

                    });
                    values.shopifycustomers_list = getModuleList;
                }
            }
            dt_datatable.Dispose();
        }
        public void DaGetLeadmoved(string user_gid, shopifycustomermovingtolead values)
        {
            for (int i = 0; i < values.shopifycustomers_lists.ToArray().Length; i++)
            {
                msSQL = "select leadbank_gid from crm_trn_tleadbank where shopify_id='" + values.shopifycustomers_lists[i].shopify_id + "' ";
                dt_datatable = objdbconn.GetDataTable(msSQL);
                if (dt_datatable.Rows.Count == 0)
                {
                    msSQL = " Select source_gid  from crm_mst_tsource where source_name = '" + values.source_name + "' ";
                    objODBCDatareader = objdbconn.GetDataReader(msSQL);
                    if (objODBCDatareader.HasRows)
                    {
                        lssource_name = objODBCDatareader["source_gid"].ToString();
                    }
                   
                    //msSQL = " Select leadbank_name  from crm_trn_tleadbank where  leadbank_gid = '" + values.leadbank_name + "'";
                    //string lsleadbank_name = objdbconn.GetExecuteScalar(msSQL);
                    //msSQL = " Select  categoryindustry_name from crm_mst_tcategoryindustry where categoryindustry_gid = '" + values.categoryindustry_name + "'";
                    //string lscategoryindustry_name = objdbconn.GetExecuteScalar(msSQL);
                    //msSQL = " Select country_gid  from adm_mst_tcountry where country_name = '" + values.shopifycustomers_lists[i].default_country + "'";
                    //string lscountry_gid = objdbconn.GetExecuteScalar(msSQL);
                    msSQL = " Select country_gid  from adm_mst_tcountry where country_name = '" + values.shopifycustomers_lists[i].default_country + "' ";
                    objODBCDatareader = objdbconn.GetDataReader(msSQL);
                    if (objODBCDatareader.HasRows)
                    {
                        lscountry_gid = objODBCDatareader["country_gid"].ToString();
                    }
                    msSQL = " Select  employee_gid  from hrm_mst_temployee where  user_gid = '" + user_gid + "'";
                    string employee_gid = objdbconn.GetExecuteScalar(msSQL);



                    msGetGid = objcmnfunctions.GetMasterGID("BMCC");
                    msGetGid1 = objcmnfunctions.GetMasterGID("BLBP");

                    msSQL = " INSERT INTO crm_trn_tleadbank(" +
                            " leadbank_gid," +
                            " shopify_id," +
                            " source_gid," +
                            " leadbank_id," +
                            " status," +
                            " approval_flag, " +
                            " lead_status," +
                            " leadbank_code," +
                            " leadbank_address1," +
                            " leadbank_address2," +
                            " leadbank_country," +
                            " leadbank_city," +
                            " leadbank_pin," +
                            " customer_type," +
                            " main_branch," +
                            " leadbank_name," +
                            " created_by," +
                            " created_date)" +
                            " values(" +
                            " '" + msGetGid1 + "'," +
                            " '" + values.shopifycustomers_lists[i].shopify_id + "'," +
                            " '" + lssource_name + "'," +
                            " '" + msGetGid + "'," +
                            " 'y'," +
                            " 'Approved'," +
                            " 'Not Assigned'," +
                            " 'H.Q'," +
                            " '" + values.shopifycustomers_lists[i].default_address1 + "'," +
                            " '" + values.shopifycustomers_lists[i].default_address2 + "'," +
                            " '" + values.shopifycustomers_lists[i].default_country + "'," +
                            " '" + values.shopifycustomers_lists[i].default_city + "'," +
                            " '" + values.shopifycustomers_lists[i].default_zip + "'," +
                            " '" + values.customer_type + "'," +
                            "'Y',";
                    if (values.shopifycustomers_lists[i].default_company == null || values.shopifycustomers_lists[i].default_company =="")
                    {
                        msSQL += "'" + values.shopifycustomers_lists[i].email + "',"; ;
                    }
                    else
                    {
                        msSQL += "'" + values.shopifycustomers_lists[i].default_company + "',";
                    }
                    msSQL += "'" + employee_gid + "'," +
                                " '" + DateTime.Now.ToString("yyyy-MM-dd") + "')";
                    mnResult = objdbconn.ExecuteNonQuerySQL(msSQL);
                    msGetGid2 = objcmnfunctions.GetMasterGID("BLBP");
                    if (msGetGid2 == "E")
                    {
                        values.status = false;
                        values.message = "Create sequence code BLCC for Lead Bank";
                    }
                    msSQL = " INSERT INTO crm_trn_tleadbankcontact" +
                        " (leadbankcontact_gid," +
                        " leadbank_gid," +
                        " leadbankcontact_name," +
                        " email, mobile," +
                        " country_code1," +
                        " created_date," +
                        " created_by," +
                        " leadbankbranch_name, " +
                        " address1, " +
                        " address2, " +
                        " city, " +
                        " pincode, " +
                        " country_gid, " +
                        " main_contact)" +
                        " values( " +
                        " '" + msGetGid2 + "'," +
                        " '" + msGetGid1 + "'," +
                        " '" + values.shopifycustomers_lists[i].first_name + "  "  + values.shopifycustomers_lists[i].last_name + "'," +
                        " '" + values.shopifycustomers_lists[i].email + "'," +
                        " '" + values.shopifycustomers_lists[i].default_phone + "'," +
                        " '" + values.shopifycustomers_lists[i].default_countrycode + "'," +
                        " '" + DateTime.Now.ToString("yyyy-MM-dd") + "'," +
                        " '" + employee_gid + "'," +
                        " 'H.Q'," +
                        " '" + values.shopifycustomers_lists[i].default_address1 + "'," +
                        " '" + values.shopifycustomers_lists[i].default_address2 + "'," +
                  " '" + values.shopifycustomers_lists[i].default_city + "'," +
                        " '" + values.shopifycustomers_lists[i].default_zip + "'," +
                        " '" + lscountry_gid + "'," +
                        " 'y'" + ")";
                    mnResult1 = objdbconn.ExecuteNonQuerySQL(msSQL);

                    msSQL = "select module2employee_gid from adm_mst_tmodule2employee where hierarchy_level ='5' and module_gid = 'MKT' and employee_gid='" + employee_gid + "' ";
                    dt_datatable = objdbconn.GetDataTable(msSQL);
                    if (dt_datatable.Rows.Count != 0)
                    {
                        msSQL = "select a.campaign_gid,b.campaign_title from crm_trn_tcampaign2employee a " +
                         " left join crm_trn_tcampaign b on a.campaign_gid=b.campaign_gid " +
                         " where a.employee_gid='" + employee_gid + "'";
                        dt_datatable = objdbconn.GetDataTable(msSQL);
                        string lscampaign_gid = objdbconn.GetExecuteScalar(msSQL);
                        if (dt_datatable.Rows.Count != 0)
                        {
                            msGetGid6 = objcmnfunctions.GetMasterGID("BLCC");
                            if (msGetGid6 == "E")
                            {
                                values.status = false;
                                values.message = "Create sequence code BLCC for lead bank";
                            }
                            msSQL = " Insert into crm_trn_tlead2campaign ( " +
                                       " lead2campaign_gid, " +
                                       " leadbank_gid, " +
                                       " campaign_gid, " +
                                       " created_by, " +
                                       " created_date, " +
                                       " lead_status, " +
                                       " leadstage_gid, " +
                                       " assign_to ) " +
                                       " Values ( " +
                                       " '" + msGetGid6 + "'," +
                                       " '" + msGetGid1 + "'," +
                                       " '" + lscampaign_gid + "'," +
                                       " '" + employee_gid + "'," +
                                       " '" + DateTime.Now.ToString("yyyy-MM-dd") +
                                       " 'Open'," +
                                       " '1'," +
                                       " '" + employee_gid + "'," + "')";
                            mnResult9 = objdbconn.ExecuteNonQuerySQL(msSQL);
                            if (mnResult9 == 1)
                            {
                                msSQL = " update crm_trn_tleadbank Set " +
                                   " lead_status = 'Assigned' " +
                                   " where leadbank_gid = '" + msGetGid1 + "' ";
                            }
                        }
                    }

                    mnResult = objdbconn.ExecuteNonQuerySQL(msSQL);
                    if (mnResult != 0)
                    {
                        values.status = true;
                        values.message = "Lead Moved Successfully";
                    }
                    else
                    {
                        values.status = false;
                        values.message = "Error Occurred While Lead Moving";
                    }


                }

            }
        }


    }
}