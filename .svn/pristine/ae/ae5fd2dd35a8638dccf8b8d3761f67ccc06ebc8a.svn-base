import { Component } from '@angular/core';
import { FormArray, FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';
import { SocketService } from 'src/app/ems.utilities/services/socket.service';
import { ToastrService } from 'ngx-toastr';
import { Router } from '@angular/router';
import { HttpParams } from '@angular/common/http';
import { AES } from 'crypto-js';
import { Options } from 'flatpickr/dist/types/options';
import { SelectionModel } from '@angular/cdk/collections';
interface ISalaryGrade {
  componentgroup_gid: string;
  componentgroup_code: string;
  componentgroup_name: string;
  display_name: string;
  statutory: string;
  net_salary: string;
  template_name:string,




}
@Component({
  selector: 'app-pay-trn-addsalarygrade-template',
  templateUrl: './pay-trn-addsalarygrade-template.component.html',
  styleUrls: ['./pay-trn-addsalarygrade-template.component.scss']
})
export class PayTrnAddsalarygradeTemplateComponent {
 reactiveFormadd!: FormGroup;
  SalaryGrade!: ISalaryGrade;
  addition_list: any[] = []
  deduction_list: any[] = []
  calculate_addition: any[] = []
  calculate_deduction: any[] = []
  componentOptions: any[][] = [
    ['componentOptions1:any[] = []'],
    ['componentOptions2:any[] = []'],
    ['componentOptions3:any[] = []'],   
    ['componentOptions4:any[] = []'],
    ['componentOptions5:any[] = []'],
    ['componentOptions6:any[] = []'],  
  ];
  componentOptions1: any[][] = [
    ['componentOption1:any[] = []'],
    ['componentOption2:any[] = []'],
    ['componentOption3:any[] = []'],   
    ['componentOption4:any[] = []'],
    ['componentOption5:any[] = []'],
    ['componentOption6:any[] = []'],  
  ];
  responsedata: any;
  selection: any;
 
 
  constructor(private formBuilder: FormBuilder,
     private ToastrService: ToastrService,
      public service: SocketService,
      private router: Router,) {
    
  }
  ngOnInit(): void {
    this.Addtictionsummary();
    this.deductionsummary();
    this.reactiveFormadd = new FormGroup({
      componentgroup_gid :new FormControl(''),
      componentgroup_code :new FormControl(''),
      componentgroup_name:new FormControl(''),
      display_name:new FormControl(''),
      statutory: new FormControl(''),
      template_name: new FormControl(''),
      component_name: new FormControl(''),
      basic_salary: new FormControl(''),
      employee_contribution :new FormControl(''),
      employer_contribution: new FormControl(''),
      demployee_contribution :new FormControl(''),
      demployer_contribution: new FormControl(''),
      gross_salary: new FormControl(''),
      grand_salary: new FormControl(''),
      ctc: new FormControl(''),
      net_salary: new FormControl(''),
      addition_list: this.formBuilder.array([]),
      deduction_list: this.formBuilder.array([])
      

    });

  }
  onBasicSalaryChange(){
    debugger;
    let totalAddEmployeeContribution = 0;
    let totalAddEmployerContribution = 0;
    let totalDedEmployeeContribution = 0;
    let totalDedEmployerContribution = 0;

    for (let i = 0; i < this.addition_list.length; i++) {
      totalAddEmployeeContribution += parseFloat(this.addition_list[i].employee_contribution || 0);
    }

    for (let i = 0; i < this.addition_list.length; i++) {
      totalAddEmployerContribution += parseFloat(this.addition_list[i].employer_contribution || 0);
    }

    for (let i = 0; i < this.deduction_list.length; i++) {
      totalDedEmployeeContribution += parseFloat(this.deduction_list[i].demployee_contribution || 0);
    }

    for (let i = 0; i < this.deduction_list.length; i++) {
      totalDedEmployerContribution += parseFloat(this.deduction_list[i].demployer_contribution || 0);
    }


    const newBasicSalary = parseFloat(this.reactiveFormadd.get('basic_salary')?.value || 0);
    const grossSalary = newBasicSalary + totalAddEmployeeContribution;
    const grand_salary = grossSalary + totalAddEmployerContribution;
    const ctc = grand_salary + totalDedEmployerContribution;
    const net_salary = grand_salary - totalDedEmployeeContribution;
    this.reactiveFormadd.patchValue({
      gross_salary: grossSalary,
      grand_salary: grand_salary,
      net_salary: net_salary,
      ctc: ctc,
    });
}



 



  Addtictionsummary(){
    var url = 'PayTrnSalaryGrade/AdditionComponentSummary'
    this.service.get(url).subscribe((result: any) => {
  
      this.responsedata = result;
      this.addition_list = this.responsedata.addition_list;
      this.addition_list.forEach((item) => {
        item.employee_contribution = ('');
        item.employer_contribution = ('');
      });
  
      setTimeout(() => {
        $('#addition_list').DataTable();
      }, 1);
  
  
    });

  }
  
  calculateaddition1(salarycomponent_gid: string, n: number): void { 
    debugger;
    var url1 = 'PayTrnSalaryGrade/Getcomponentamount';
    let param: { salarycomponent_gid: any } = {
      salarycomponent_gid: salarycomponent_gid
    };
    this.service.getparams(url1, param).subscribe((result: any) => {
      this.calculate_addition[0] = result.Getcomponentamount[0];
      const component_flag_employer = this.calculate_addition[0].component_flag_employer;
      const component_flag = this.calculate_addition[0].component_flag;
      const component_percentage = this.calculate_addition[0].component_percentage;
      const component_amount = this.calculate_addition[0].component_amount;
      const component_percentage_employer = this.calculate_addition[0].component_percentage_employer;
      const component_amount_employer = this.calculate_addition[0].component_amount_employer;
      const newBasicSalary = this.reactiveFormadd.get('basic_salary')?.value;
      debugger;
      if (component_flag == "Y") {
        this.addition_list[n].employee_contribution = (newBasicSalary) * (component_percentage / 100)
        this.reactiveFormadd.addControl(`employee_contribution_${n}`, new FormControl(this.addition_list[n].employee_contribution));
       } 
      else {
        this.addition_list[n].employee_contribution = component_amount
        this.reactiveFormadd.addControl(`employee_contribution_${n}`, new FormControl(this.addition_list[n].employee_contribution));
        }

      if (component_flag_employer == "Y") {

        this.addition_list[n].employer_contribution = (newBasicSalary) * (component_percentage_employer / 100)
        this.reactiveFormadd.addControl(`employer_contribution_${n}`, new FormControl(this.addition_list[n].employer_contribution));
       } else {

        this.addition_list[n].employer_contribution = component_amount_employer
        this.reactiveFormadd.addControl(`employer_contribution_${n}`, new FormControl(this.addition_list[n].employer_contribution));
         }

     });

  }
  
  getoptions(componentgroup_name: any,n:number) {
    var url1 = 'PayTrnSalaryGrade/Getcomponentname';
    let param: { componentgroup_name: any } = {
        componentgroup_name: componentgroup_name
    };
    this.service.getparams(url1,param).subscribe((result: any) => {
        this.componentOptions[n] = result.GetComponentname;   
    });
}

  deductionsummary(){
    var url = 'PayTrnSalaryGrade/DeductionComponentSummary'
    this.service.get(url).subscribe((result: any) => {
  
      this.responsedata = result;
      this.deduction_list = this.responsedata.deduction_list;
      this.deduction_list.forEach((item1 :any) => {
        item1.demployee_contribution = ('');
        item1.demployer_contribution = ('');
      });
    
  
      setTimeout(() => {
        $('#deduction_list').DataTable();
      }, 1);
  
  
    });

  }
  getdeduction(componentgroup_name: any,n:number) {
    var url1 = 'PayTrnSalaryGrade/Getcomponentname';
    let param: { componentgroup_name: any } = {
        componentgroup_name: componentgroup_name
    };
    this.service.getparams(url1,param).subscribe((result: any) => {
        this.componentOptions1[n] = result.GetComponentname;
    });
}

  
submit() {
  console.log(this.addition_list)
  console.log(this.deduction_list)

  var params={ 
    addition_list : this.addition_list,
    deduction_list: this.deduction_list,
    newBasicSalary : this.reactiveFormadd.value.basic_salary,
    template_name : this.reactiveFormadd.value.template_name,
    gross_salary : this.reactiveFormadd.value.gross_salary,
    ctc : this.reactiveFormadd.value.ctc,
    net_salary : this.reactiveFormadd.value.net_salary,
  }
  console.log(params)

  var url = 'PayTrnSalaryGrade/PostSalaryGrade'
    this.service.postparams(url,params).subscribe((result: any) => {
      if (result.status == false) {
        this.ToastrService.warning(result.message)
        this.router.navigate(['/payroll/PayTrnSalaryGradeTemplate']);

     }
     else{
      this.ToastrService.success(result.message)
      this.router.navigate(['/payroll/PayTrnSalaryGradeTemplate']);


     }

    });

}
  calculatededuction(salarycomponent_gid: string, n: number): void { 
    debugger;
    var url1 = 'PayTrnSalaryGrade/Getcomponentamount';
    let param: { salarycomponent_gid: any } = {
      salarycomponent_gid: salarycomponent_gid
    };
    this.service.getparams(url1, param).subscribe((result: any) => {
      this.calculate_deduction[0] = result.Getcomponentamount[0];
      const component_flag_employer = this.calculate_deduction[0].component_flag_employer;
      const component_flag = this.calculate_deduction[0].component_flag;
      const component_percentage = this.calculate_deduction[0].component_percentage;
      const component_amount = this.calculate_deduction[0].component_amount;
      const component_percentage_employer = this.calculate_deduction[0].component_percentage_employer;
      const component_amount_employer = this.calculate_deduction[0].component_amount_employer;
      
      const newBasicSalary = this.reactiveFormadd.get('basic_salary')?.value;
      debugger;
      if (component_flag == "Y") {
        this.deduction_list[n].demployee_contribution = (newBasicSalary) * (component_percentage / 100)
        this.reactiveFormadd.addControl(`demployee_contribution_${n}`, new FormControl(this.deduction_list[n].demployee_contribution));
       } 
      else {
        this.deduction_list[n].demployee_contribution = component_amount
        this.reactiveFormadd.addControl(`demployee_contribution_${n}`, new FormControl(this.deduction_list[n].demployee_contribution));
        }

      if (component_flag_employer == "Y") {

        this.deduction_list[n].demployer_contribution = (newBasicSalary) * (component_percentage_employer / 100)
        this.reactiveFormadd.addControl(`demployer_contribution_${n}`, new FormControl(this.deduction_list[n].demployer_contribution));
       } else {

        this.deduction_list[n].demployer_contribution = component_amount_employer
        this.reactiveFormadd.addControl(`demployer_contribution_${n}`, new FormControl(this.deduction_list[n].demployer_contribution));
         }

     });

  }
  


}


