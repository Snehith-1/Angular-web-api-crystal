using ems.sales.Models;
using ems.utilities.Functions;
using System;
using System.Collections.Generic;
using System.Data.Odbc;
using System.Data;
using System.Linq;
using System.Web;
using System.Runtime.Remoting;

namespace ems.sales.DataAccess
{
    public class DaSmrDashboard
    {
        dbconn objdbconn = new dbconn();
        cmnfunctions objcmnfunctions = new cmnfunctions();
        string msSQL = string.Empty;
        OdbcDataReader objODBCDatareader;
        DataTable dt_datatable;
        string msGetGid;
        int mnResult, mnResult1;
        string lsemployee_gid_list;

        // Recursive Looping ChildLoop Function to get Employee GID Hierarchywise

        public void DaGetChildLoop(string employee_gid, MdlSmrDashboard values)
        {
            msSQL = " select a.employee_gid, concat(b.user_firstname, '-', b.user_code) as user  from adm_mst_tmodule2employee a  " +
                 " inner join hrm_mst_temployee c on a.employee_gid = c.employee_gid   " +
                 " inner join adm_mst_tuser b on c.user_gid = b.user_gid   " +
                 " where a.module_gid = 'MKT'  " +
                 " and a.employeereporting_to = '" + employee_gid + "' ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var SalesPerformanceChart_List = new List<GetSalesPerformanceChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    string lsemployee_gid = dt["employee_gid"].ToString();
                    msSQL = " select a.*, b.user_gid,c.employee_gid  from adm_mst_tmodule2employee a  " +
                " inner join hrm_mst_temployee c on a.employee_gid = c.employee_gid  " +
                " inner join adm_mst_tuser b on c.user_gid = b.user_gid  " +
                " where a.module_gid = 'MKT' " +
                " and a.employee_gid ='" + lsemployee_gid + "'";
                    dt_datatable = objdbconn.GetDataTable(msSQL);
                    if (dt_datatable.Rows.Count != 0)
                    {
                        lsemployee_gid_list = lsemployee_gid + "," + dt["employee_gid"].ToString() + ",";
                        //SalesPerformanceChart_List.Add(new GetSalesPerformanceChart_List
                        //{
                        //    lsemployee_gid_list = lsemployee_gid + (dt["employee_gid"].ToString()) +",",
                        //});
                        //values.GetSalesPerformanceChart_List = SalesPerformanceChart_List;
                    }
                    DaGetChildLoop(lsemployee_gid, values);
                }

            }
        }

        // SalesPerformanceChart
        public void DaGetSalesPerformanceChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " select sum(a.grandtotal) as order_amount,sum(a.received_amount) as payment_amount, sum(a.invoice_amount) as invoice_amount, " +
                 " cast(MONTHNAME(a.salesorder_date) as char) as orderdate, " +
                 " sum(a.invoice_amount-a.received_amount)  as outstanding_amount " +
                 " from smr_trn_tsalesorder a " +
                 " where a.salesorder_status in ('Delivery Completed','Approved') " +
                 " and created_by in ( '" + user_gid + "') " +
                 " and a.salesorder_date BETWEEN CURDATE() - INTERVAL 6 MONTH AND CURDATE() " +
                 " group by MONTH(salesorder_date) desc order by a.salesorder_date desc ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var SalesPerformanceChart_List = new List<GetSalesPerformanceChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    SalesPerformanceChart_List.Add(new GetSalesPerformanceChart_List
                    {
                        order_amount = (dt["order_amount"].ToString()),
                        payment_amount = (dt["payment_amount"].ToString()),
                        invoice_amount = (dt["invoice_amount"].ToString()),
                        orderdate = (dt["orderdate"].ToString()),
                        outstanding_amount = (dt["outstanding_amount"].ToString()),

                    });
                    values.GetSalesPerformanceChart_List = SalesPerformanceChart_List;
                }
            }
            dt_datatable.Dispose();
        }


        // GetSalesOrderCount
        public void DaGetSalesOrderCount(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = "SELECT " +
     "(SELECT COUNT(*) AS total_so FROM smr_trn_tsalesorder b WHERE b.salesorder_status NOT IN ('SO Amended')) AS total_so, " +
     "(SELECT COUNT(*) AS approved_so FROM smr_trn_tsalesorder c WHERE c.salesorder_status = 'Approved') AS approved_so, " +
     "(SELECT COUNT(*) AS pending_so FROM smr_trn_tsalesorder d WHERE d.salesorder_status = 'Approve Pending') AS pending_so, " +
     "(SELECT COUNT(*) AS rejected_so FROM smr_trn_tsalesorder e WHERE e.salesorder_status = 'Rejected') AS rejected_so, " +
     "(SELECT COUNT(*) AS work_in_progress FROM smr_trn_tsalesorder f WHERE f.salesorder_status = 'Work In Progress') AS work_in_progress, " +
     "(SELECT COUNT(*) AS delivery_done_partial FROM smr_trn_tsalesorder g WHERE g.salesorder_status = 'Delivery Done Partial') AS delivery_done_partial, " +
     "(SELECT COUNT(*) AS advanced_paid FROM smr_trn_tsalesorder h WHERE h.salesorder_status = 'Advance Paid') AS advanced_paid, " +
     "(SELECT COUNT(*) AS delivery_completed FROM smr_trn_tsalesorder i WHERE i.salesorder_status = 'Delivery Completed') AS delivery_completed, " +
     "(SELECT COUNT(*) AS invoice_raised FROM smr_trn_tsalesorder k WHERE k.salesorder_status = 'Invoice Raised') AS invoice_raised, " +
     "(SELECT COUNT(*) AS so_amended FROM smr_trn_tsalesorder j WHERE j.salesorder_status = 'SO Amended') AS so_amended, " +
     "(SELECT COUNT(invoice_gid) AS totalinvoice FROM rbl_trn_tinvoice WHERE invoice_flag <> 'Invoice Cancelled') AS totalinvoice, " +
     "(SELECT COUNT(invoice_gid) AS approval_pending FROM rbl_trn_tinvoice WHERE invoice_flag = 'Invoice Approved') AS approval_pending, " +
     "(SELECT COUNT(invoice_gid) AS payment_pending FROM rbl_trn_tinvoice WHERE payment_amount = '0.00') AS payment_pending, " +
     "(SELECT COUNT(invoice_gid) AS approval_pending_invoice FROM rbl_trn_tinvoice WHERE invoice_flag = 'Invoice Approval Pending') AS approval_pending_invoice, " +
     "(SELECT COUNT(invoice_gid) AS approval_pending_invoice FROM rbl_trn_tinvoice WHERE invoice_flag = 'Payment  done partial') AS approvalpendinginnvoice, " +
     "(SELECT COUNT(invoice_gid) FROM rbl_trn_tinvoice WHERE invoice_status = 'Payment Approved') AS compelted_payment, " +
     "(SELECT COUNT(invoice_gid) FROM rbl_trn_tinvoice WHERE invoice_status = 'Payment Done') AS total_payment, " +
     "(SELECT COUNT(invoice_gid) AS payment_done_partial FROM rbl_trn_tinvoice WHERE payment_amount = 'Payment Done Partial') AS payment_don_partial, " +
     "(SELECT COUNT(quotation_gid) FROM smr_trn_treceivequotation) AS total_quotation, " +
     "(SELECT COUNT(quotation_gid) FROM smr_trn_treceivequotation WHERE quotation_status = 'Quotation Amended') AS quotation_amended, " +
     "(SELECT COUNT(quotation_gid) FROM smr_trn_tsalesdelete WHERE record_reference = 'Quotation') AS quotation_cancelled " +
     "FROM smr_trn_tsalesorder a " +
     "LEFT JOIN rbl_trn_tinvoice b ON b.customer_gid = a.customer_gid " +
     "WHERE a.salesorder_status <> 'SO Amended' " +
     "GROUP BY salesorder_gid";





            dt_datatable = objdbconn.GetDataTable(msSQL);
            var GetSalesOrderCount_List = new List<GetSalesOrderCount_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    GetSalesOrderCount_List.Add(new GetSalesOrderCount_List
                    {
                        total_so = (dt["total_so"].ToString()),
                        approved_so = (dt["approved_so"].ToString()),
                        pending_So = (dt["pending_So"].ToString()),
                        rejected_so = (dt["rejected_so"].ToString()),
                        work_in_progress = (dt["work_in_progress"].ToString()),
                        delivery_done_partial = (dt["delivery_done_partial"].ToString()),
                        advanced_paid = (dt["advanced_paid"].ToString()),
                        delivery_completed = (dt["delivery_completed"].ToString()),
                        invoice_raised = (dt["invoice_raised"].ToString()),
                        so_amended = (dt["so_amended"].ToString()),
                        totalinvoice = (dt["totalinvoice"].ToString()),
                        approval_pending = (dt["approval_pending"].ToString()),
                        payment_pending = (dt["payment_pending"].ToString()),
                        approvalpendinginnvoice = (dt["approvalpendinginnvoice"].ToString()),
                        total_quotation = (dt["total_quotation"].ToString()),
                        total_payment = (dt["total_payment"].ToString()),
                        quotation_canceled = (dt["quotation_amended"].ToString()),
                        quotation_completed = (dt["quotation_cancelled"].ToString()),
                        payment_don_partial = (dt["payment_don_partial"].ToString()),
                        compelted_payment = (dt["compelted_payment"].ToString()),

                    });
                    values.GetSalesOrderCount_List = GetSalesOrderCount_List;
                }
            }
            dt_datatable.Dispose();

        }

        // GetSalesMoreOrderCount
        public void DaGetMoreSalesOrderCount(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " SELECT count(invoice_gid) as totalinvoice FROM rbl_trn_tinvoice where invoice_flag <> 'Invoice Cancelled' and user_gid in ( '" + user_gid + "') ";
            values.totalinvoice = objdbconn.GetExecuteScalar(msSQL);
            msSQL = " SELECT count(invoice_gid) as approval_pending FROM rbl_trn_tinvoice where invoice_flag = 'Invoice Approved' and user_gid in ( '" + user_gid + "') ";
            values.approval_pending = objdbconn.GetExecuteScalar(msSQL);
            msSQL = " select count(invoice_gid) as payment_pending from rbl_trn_tinvoice where  payment_amount='0.00' and user_gid in ( '" + user_gid + "') ";
            values.payment_pending = objdbconn.GetExecuteScalar(msSQL);
            msSQL = " SELECT count(invoice_gid) as totalinvoice FROM rbl_trn_tinvoice where invoice_flag = 'Invoice Approval Pending' and user_gid in ( '" + user_gid + "') ";
            values.approvalpendinginnvoice = objdbconn.GetExecuteScalar(msSQL);
            msSQL = " select count(lead2campaign_gid) as potentialleadcount from crm_trn_tenquiry2campaign where leadstage_gid='5' and created_by in ( ( '" + employee_gid + "') ";
            values.potentialleadcount = objdbconn.GetExecuteScalar(msSQL);
        }
        // GetOwnOverallSalesOrderChart
        public void DaGetOwnOverallSalesOrderChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " select count(*) as count_own,salesorder_status as status from smr_trn_tsalesorder where " +
                " created_by='" + employee_gid + "' and so_type='Sales' " +
                " group by salesorder_status ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var OverallSalesOrderChart_List = new List<GetOverallSalesOrderChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    OverallSalesOrderChart_List.Add(new GetOverallSalesOrderChart_List
                    {
                        count_own = (dt["count_own"].ToString()),
                        salesorder_status_own = (dt["salesorder_status_own"].ToString()),

                    });
                    values.GetOverallSalesOrderChart_List = OverallSalesOrderChart_List;
                }
            }
            dt_datatable.Dispose();
        }
        // GetHierarchyOverallSalesOrderChart
        public void DaGetHierarchyOverallSalesOrderChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {

            msSQL = " select count(*) as count_Hierarchy,salesorder_status_Hierarchy as status from smr_trn_tsalesorder where " +
                " created_by in ('" + employee_gid + "') and so_type='Sales' " +
                " group by salesorder_status ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var OverallSalesOrderChart_List = new List<GetOverallSalesOrderChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    OverallSalesOrderChart_List.Add(new GetOverallSalesOrderChart_List
                    {
                        count_Hierarchy = (dt["count_Hierarchy"].ToString()),
                        salesorder_status_Hierarchy = (dt["salesorder_status_Hierarchy"].ToString()),

                    });
                    values.GetOverallSalesOrderChart_List = OverallSalesOrderChart_List;
                }
            }
            dt_datatable.Dispose();
        }
        // GetOwnOverallDeliveryOrderChart
        public void DaGetOwnOverallDeliveryOrderChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " select count(*) as do_count_own,delivery_status as delivery_status_own from smr_trn_tdeliveryorder where " +
                " created_name='" + employee_gid + "' " +
                " group by delivery_status ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var OverallSalesOrderChart_List = new List<GetOverallSalesOrderChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    OverallSalesOrderChart_List.Add(new GetOverallSalesOrderChart_List
                    {
                        do_count_own = (dt["do_count_own"].ToString()),
                        delivery_status_own = (dt["delivery_status_own"].ToString()),

                    });
                    values.GetOverallSalesOrderChart_List = OverallSalesOrderChart_List;
                }
            }
            dt_datatable.Dispose();
        }

        // GetHierarchyOverallDeliveryOrderChart
        public void DaGetHierarchyOverallDeliveryOrderChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " select count(*) as count,delivery_status as delivery_status_own from smr_trn_tdeliveryorder where " +
                " created_name in ('" + employee_gid + "') " +
                " group by delivery_status ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var OverallSalesOrderChart_List = new List<GetOverallSalesOrderChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    OverallSalesOrderChart_List.Add(new GetOverallSalesOrderChart_List
                    {
                        do_count_Hierarchy = (dt["do_count_Hierarchy"].ToString()),
                        delivery_status_Hierarchy = (dt["delivery_status_own"].ToString()),

                    });
                    values.GetOverallSalesOrderChart_List = OverallSalesOrderChart_List;
                }
            }
            dt_datatable.Dispose();
        }

        // GetMonthlySalesPipelineChart
        public void DaGetMonthlySalesPipelineChart(string employee_gid, string user_gid, MdlSmrDashboard values)
        {
            msSQL = " SELECT cast(concat(monthname(payment_date),'-',year(payment_date)) as char) as payment_day,  " +
                "(sum(amount)*exchange_rate) as amount " +
                " FROM rbl_trn_tpayment group by YEAR(payment_date),MONTH(payment_date) ";
            dt_datatable = objdbconn.GetDataTable(msSQL);
            var OverallSalesOrderChart_List = new List<GetOverallSalesOrderChart_List>();
            if (dt_datatable.Rows.Count != 0)
            {
                foreach (DataRow dt in dt_datatable.Rows)
                {
                    OverallSalesOrderChart_List.Add(new GetOverallSalesOrderChart_List
                    {
                        payment_day = (dt["payment_day"].ToString()),
                        amount = (dt["amount"].ToString()),

                    });
                    values.GetOverallSalesOrderChart_List = OverallSalesOrderChart_List;
                }
            }
            dt_datatable.Dispose();
        }

        public void DaGetMTDCounts( MdlSmrDashboard values)
        {
            msSQL = "  select count(payment_gid) as over_due_payment from rbl_trn_tpayment where payment_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 12 MONTH ";
            values.mtd_over_due_payment = objdbconn.GetExecuteScalar(msSQL);

            msSQL = "  select ifnull(format(sum(amount*exchange_rate),2),'0') as over_due_payment_amount from rbl_trn_tpayment where payment_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 12 MONTH ";
            values.mtd_over_due_payment_amount = objdbconn.GetExecuteScalar(msSQL);

            msSQL = " select ifnull(format(sum(invoice_amount*exchange_rate),2),'0') as invoice_amount from rbl_trn_tinvoice where invoice_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 12 MONTH ";
            values.mtd_over_due_invoice_amount = objdbconn.GetExecuteScalar(msSQL);

            msSQL = "  select count(invoice_gid) from rbl_trn_tinvoice where invoice_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 12 MONTH ";
            values.mtd_over_due_invoice = objdbconn.GetExecuteScalar(msSQL);

        }
        public void DaGetYTDCounts(MdlSmrDashboard values)
        {
            msSQL = "  select count(payment_gid) as over_due_payment from rbl_trn_tpayment where payment_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 24 MONTH ";
            values.ytd_over_due_payment = objdbconn.GetExecuteScalar(msSQL);

            msSQL = "  select ifnull(format(sum(amount*exchange_rate),2),'0') as over_due_payment_amount from rbl_trn_tpayment where payment_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 24 MONTH ";
            values.ytd_over_due_payment_amount = objdbconn.GetExecuteScalar(msSQL);

            msSQL = " select ifnull(format(sum(invoice_amount*exchange_rate),2),'0') as invoice_amount from rbl_trn_tinvoice where invoice_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL 24 MONTH ";
            values.ytd_over_due_invoice_amount = objdbconn.GetExecuteScalar(msSQL);

            msSQL = "  select count(invoice_gid) from rbl_trn_tinvoice where invoice_date>= DATE_FORMAT(CURDATE(), '%Y-%m-01') - INTERVAL  24 MONTH ";
            values.ytd_over_due_invoice = objdbconn.GetExecuteScalar(msSQL);
        }
    }
}